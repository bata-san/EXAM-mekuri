<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>⚡ 超高速記憶術 - 1時間完全マスター</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --card-bg: #2d2d2d;
            --primary-color: #00aaff;
            --success-color: #28a745;
            --danger-color: #ff4757;
            --warning-color: #fbc531;
            --text-color: #e0e0e0;
            --sub-text-color: #9e9e9e;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --border-color: #424242;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Dashboard Screen */
        #dashboard {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }

        #dashboard h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 32px;
        }

        #dashboard p {
            color: var(--sub-text-color);
            margin-top: 0;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            margin: 20px 0;
        }

        .stat-box {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .stat-box .label {
            font-size: 14px;
            color: var(--sub-text-color);
            margin-bottom: 5px;
        }

        .stat-box .value {
            font-size: 28px;
            font-weight: bold;
        }

        #review-value {
            color: var(--warning-color);
        }

        #mastered-value {
            color: var(--success-color);
        }

        #progress-percentage {
            color: var(--primary-color);
        }

        /* Timer Container */
        .timer-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
        }

        .timer-box {
            background: linear-gradient(135deg, var(--primary-color), var(--success-color));
            padding: 15px 25px;
            border-radius: 12px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .timer-label {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .timer-value {
            font-size: 24px;
            font-weight: bold;
        }

        /* Speed Learning Indicators */
        .speed-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--success-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .ultra-fast {
            background: var(--danger-color);
        }

        #remaining-value {
            color: var(--warning-color);
        }

        #memorized-value {
            color: var(--success-color);
        }

        #memory-percentage {
            color: var(--primary-color);
        }

        .start-btn {
            width: 100%;
            max-width: 400px;
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            background-color: var(--primary-color);
            color: white;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .start-btn:hover {
            filter: brightness(1.1);
        }

        .start-btn:active {
            transform: scale(0.98);
        }

        /* Study Screen */
        #study-screen {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .study-header {
            padding: 15px;
            text-align: center;
            background: var(--card-bg);
            box-shadow: 0 2px 4px var(--shadow-color);
            z-index: 10;
            position: relative;
        }

        .progress-info {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .speed-mode-indicator {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--danger-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Card Area */
        .card-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }

        .card {
            width: 100%;
            max-width: 450px;
            height: 480px;
            perspective: 1000px;
            user-select: none;
            cursor: pointer;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.5s ease, opacity 0.3s ease, transform 0.3s ease;
            border-radius: 16px;
            box-shadow: 0 8px 30px var(--shadow-color);
        }

        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            box-sizing: border-box;
            background: var(--card-bg);
            text-align: center;
        }

        .card-back {
            transform: rotateY(180deg);
        }

        .topic-tag {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 170, 255, 0.2);
            color: var(--primary-color);
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .question {
            font-size: 22px;
            font-weight: 600;
            line-height: 1.5;
        }

        .answer {
            font-size: 24px;
            font-weight: bold;
            line-height: 1.4;
        }

        /* Evaluation UI */
        .eval-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            border-top: 3px solid var(--primary-color);
        }

        .eval-container.show {
            transform: translateY(0);
        }

        .eval-step {
            display: none;
        }

        .eval-step.active {
            display: block;
            text-align: center;
        }

        .eval-step p {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .eval-btns {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .eval-btn {
            flex: 1;
            max-width: 200px;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 12px;
            border: none;
            transition: all 0.2s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .eval-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .eval-btn:active {
            transform: scale(0.98);
        }

        .eval-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-knew {
            background-color: var(--success-color);
            color: white;
        }

        .btn-didnt-know {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-confident {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-not-confident {
            background-color: var(--warning-color);
            color: white;
        }

        #back-to-dash {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 200;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        strong {
            color: #ffab40;
        }

        /* Scientific Memory Enhancement Features */
        .recall-test {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 10px 0;
            animation: slideInUp 0.5s ease-out;
        }

        .recall-prompt {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .recall-question {
            font-size: 16px;
            margin: 15px 0;
            line-height: 1.5;
        }

        .recall-hint {
            font-size: 12px;
            opacity: 0.8;
            animation: pulse 2s infinite;
        }

        .recall-benefit {
            font-size: 11px;
            margin-top: 10px;
            opacity: 0.7;
            font-style: italic;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }

        .self-explanation-prompt {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #333;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #ff6b9d;
            animation: slideInUp 0.3s ease-out;
            transition: all 0.3s ease;
        }

        .explanation-header {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .explanation-text {
            font-size: 15px;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .explanation-timer {
            font-size: 12px;
            opacity: 0.7;
            text-align: center;
        }

        .timer-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin: 8px 0;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b9d, #c44569);
            width: 0%;
            transition: width 0.1s ease;
        }

        @keyframes timer-progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Memory Progress Indicators */
        .memory-level-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            z-index: 5;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .memory-level-0 { background-color: #ff4444; }
        .memory-level-1 { background-color: #ff8800; }
        .memory-level-2 { background-color: #44aa44; }
        .memory-level-3 { background-color: #0088ff; }

        /* Feedback Messages */
        .feedback-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 2000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .feedback-message.success {
            background: var(--success-color);
            color: white;
        }

        .feedback-message.info {
            background: var(--primary-color);
            color: white;
        }

        .feedback-message.warning {
            background: var(--warning-color);
            color: white;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .study-header {
                padding: 10px;
            }
            
            .eval-btns {
                flex-direction: column;
                gap: 15px;
            }
            
            .eval-btn {
                min-height: 50px;
            }
            
            .self-explanation-prompt {
                margin: 10px 0;
                padding: 15px;
            }
            
            .explanation-header {
                font-size: 16px;
            }
            
            .explanation-text {
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Dashboard Screen -->
        <div id="dashboard">
            <h1>⚡ 超高速記憶術</h1>
            <p>科学的間隔反復で超スピード暗記マスター</p>
            <div class="timer-container">
                <div class="timer-box">
                    <div class="timer-label">学習時間</div>
                    <div class="timer-value" id="study-timer">00:00</div>
                </div>
                <div class="timer-box">
                    <div class="timer-label">目標時間</div>
                    <div class="timer-value">60:00</div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="label">全問題数</div>
                    <div class="value" id="total-value">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">残り問題</div>
                    <div class="value" id="remaining-value">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">記憶済み</div>
                    <div class="value" id="memorized-value">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">記憶率</div>
                    <div class="value" id="memory-percentage">0%</div>
                </div>
            </div>
            <button class="start-btn" id="ultra-speed-btn">🚀 超高速学習開始</button>
            <button class="start-btn" id="review-cycle-btn" style="background-color: var(--warning-color);">🔄 間隔反復復習</button>
            <button class="start-btn" id="reset-progress"
                style="margin-top:20px; background-color: #6c757d; font-size: 14px;">学習記録をリセット</button>
        </div>

        <!-- Study Screen -->
        <div id="study-screen">
            <div class="study-header">
                <div class="progress-info" id="progress-info"></div>
                <div class="speed-mode-indicator">超高速モード</div>
            </div>
            <div class="card-area" id="card-area">
                <div class="card" id="card">
                    <div class="memory-level-indicator" id="memory-indicator"></div>
                    <div class="card-inner" id="card-inner">
                        <div class="card-face card-front">
                            <span class="topic-tag" id="front-topic-tag"></span>
                            <div class="speed-indicator" id="speed-indicator">3秒以内</div>
                            <p class="question" id="question"></p>
                        </div>
                        <div class="card-face card-back">
                            <span class="topic-tag" id="back-topic-tag"></span>
                            <p class="answer" id="answer"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="back-to-dash" title="ダッシュボードに戻る">✕</div>

            <div class="eval-container" id="eval-container">
                <div class="eval-step" id="eval-step-1">
                    <p>瞬時に答えが浮かびましたか？</p>
                    <div class="eval-btns">
                        <button class="eval-btn btn-didnt-know" id="eval-unknown">分からない</button>
                        <button class="eval-btn btn-knew" id="eval-instant">瞬時に浮かんだ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const initialCardData =
            [
                
                { "topic": "ヨーロッパ世界", "q": "15世紀末から16世紀にかけて、ヨーロッパ人が活発に行った海外探検・植民活動を何と呼ぶか？", "a": "<strong>大航海時代</strong>" },
                { "topic": "ヨーロッパ世界", "q": "大航海時代に最初に海外進出を果たしたイベリア半島の2国は？", "a": "<strong>ポルトガルとスペイン</strong>" },
                { "topic": "ヨーロッパ世界", "q": "ポルトガルのヴァスコ・ダ・ガマが到達したインドの港は？", "a": "<strong>カリカット</strong>" },
                { "topic": "ヨーロッパ世界", "q": "コロンブスが到達した新大陸の地名は？", "a": "<strong>サンサルバドル島（西インド諸島の一部）</strong>" },
                { "topic": "ヨーロッパ世界", "q": "世界一周を達成したマゼランの船隊が発見した海峡は？", "a": "<strong>マゼラン海峡</strong>" },
                { "topic": "ヨーロッパ世界", "q": "メキシコのアステカ帝国を滅ぼしたスペインのコンキスタドールは？", "a": "<strong>コルテス</strong>" },
                { "topic": "ヨーロッパ世界", "q": "ペルーのインカ帝国を滅ぼしたスペインのコンキスタドールは？", "a": "<strong>ピサロ</strong>" },
                { "topic": "ヨーロッパ世界", "q": "大航海時代にヨーロッパにもたらされた新世界の作物は？", "a": "<strong>ジャガイモ、トウモロコシ、トマト、タバコなど</strong>" },
                { "topic": "ヨーロッパ世界", "q": "大航海時代にヨーロッパから新世界へもたらされた家畜は？", "a": "<strong>馬、牛、豚など</strong>" },
                { "topic": "ヨーロッパ世界", "q": "大航海時代により、商業の中心が地中海から大西洋沿岸に移った現象を何と呼ぶか？", "a": "<strong>商業革命</strong>" },
                { "topic": "ヨーロッパ世界", "q": "商業革命期に、銀の供給量が増大し、物価が高騰した現象は？", "a": "<strong>価格革命</strong>" },
                { "topic": "宗教改革", "q": "16世紀にヨーロッパで起こったカトリック教会への批判と改革運動を何と呼ぶか？", "a": "<strong>宗教改革</strong>" },
                { "topic": "宗教改革", "q": "ルターが発表した、教会の腐敗を批判した文書は？", "a": "<strong>95ヶ条の論題</strong>" },
                { "topic": "宗教改革", "q": "ルターを保護し、宗教改革の推進に貢献したドイツの諸侯は？", "a": "<strong>ザクセン選帝侯フリードリヒ3世</strong>" },
                { "topic": "宗教改革", "q": "ルター派を支持したドイツの諸侯や都市が、皇帝に提出した抗議文から生まれた呼び名は？", "a": "<strong>プロテスタント</strong>" },
                { "topic": "宗教改革", "q": "ルターの宗教改革を正統と認めた1555年の和議は？", "a": "<strong>アウクスブルクの宗教和議</strong>" },
                { "topic": "宗教改革", "q": "予定説を唱え、ジュネーヴで神権政治を行った人物は？", "a": "<strong>カルヴァン</strong>" },
                { "topic": "宗教改革", "q": "イギリスで国王を首長とする教会を設立した人物は？", "a": "<strong>ヘンリ8世</strong>" },
                { "topic": "宗教改革", "q": "イギリスで設立された教会を何と呼ぶか？", "a": "<strong>イギリス国教会</strong>" },
                { "topic": "絶対王政", "q": "国王が強大な権力を持ち、国家を統治する政治体制は？", "a": "<strong>絶対王政</strong>" },
                { "topic": "絶対王政", "q": "フランス絶対王政の最盛期の国王は？", "a": "<strong>ルイ14世</strong>" },
                { "topic": "絶対王政", "q": "ルイ14世が建設した豪華な宮殿は？", "a": "<strong>ヴェルサイユ宮殿</strong>" },
                { "topic": "絶対王政", "q": "ルイ14世の重商主義政策を推進した財務総監は？", "a": "<strong>コルベール</strong>" },
                { "topic": "絶対王政", "q": "イギリスでステュアート朝が絶対王政を志向し、議会と対立した革命は？", "a": "<strong>ピューリタン革命</strong>" },
                { "topic": "絶対王政", "q": "ピューリタン革命を主導した人物は？", "a": "<strong>クロムウェル</strong>" },
                { "topic": "絶対王政", "q": "イギリスで名誉革命により成立した政治体制は？", "a": "<strong>立憲君主制</strong>" },
                { "topic": "絶対王政", "q": "名誉革命で国王が承認した、議会の権利を定めた法律は？", "a": "<strong>権利の章典</strong>" },
                { "topic": "主権国家体制", "q": "主権国家間の勢力均衡によって国際秩序を保つ考え方は？", "a": "<strong>バランス・オブ・パワー</strong>" },
                { "topic": "主権国家体制", "q": "三十年戦争の講和条約で、主権国家体制が確立したとされる条約は？", "a": "<strong>ウェストファリア条約</strong>" },
                { "topic": "17・18世紀", "q": "イギリスとフランスが植民地をめぐって争った戦争は？", "a": "<strong>七年戦争</strong>" },
                { "topic": "17・18世紀", "q": "七年戦争の結果、フランスがイギリスにカナダやインドにおける植民地の権利を譲渡した条約は？", "a": "<strong>パリ条約</strong>" },
                { "topic": "啓蒙思想", "q": "18世紀にフランスを中心に広まった、理性を重んじる思想は？", "a": "<strong>啓蒙思想</strong>" },
                { "topic": "啓蒙思想", "q": "『法の精神』で権力分立を説いた思想家は？", "a": "<strong>モンテスキュー</strong>" },
                { "topic": "啓蒙思想", "q": "『社会契約論』で人民主権を説いた思想家は？", "a": "<strong>ルソー</strong>" },
                { "topic": "啓蒙思想", "q": "『百科全書』を編纂した啓蒙思想家は？", "a": "<strong>ディドロ</strong>" },
                { "topic": "アメリカ独立革命", "q": "イギリスの北米植民地が独立を宣言した出来事は？", "a": "<strong>アメリカ独立革命</strong>" },
                { "topic": "アメリカ独立革命", "q": "アメリカ独立革命の発端となった事件は？", "a": "<strong>ボストン茶会事件</strong>" },
                { "topic": "アメリカ独立革命", "q": "アメリカ独立宣言を起草した人物は？", "a": "<strong>ジェファソン</strong>" },
                { "topic": "アメリカ独立革命", "q": "アメリカ独立戦争を指揮した総司令官は？", "a": "<strong>ワシントン</strong>" },
                { "topic": "アメリカ独立革命", "q": "アメリカ独立革命で、イギリスを支援した国は？", "a": "<strong>フランス、スペイン、オランダなど</strong>" },
                { "topic": "フランス革命", "q": "1789年にフランスで起こった市民革命は？", "a": "<strong>フランス革命</strong>" },
                { "topic": "フランス革命", "q": "フランス革命の発端となった出来事は？", "a": "<strong>バスティーユ牢獄襲撃</strong>" },
                { "topic": "フランス革命", "q": "フランス革命で発表された、人間の自由と平等をうたった宣言は？", "a": "<strong>人権宣言</strong>" },
                { "topic": "フランス革命", "q": "フランス革命期の急進的な政治家で、恐怖政治を行った人物は？", "a": "<strong>ロベスピエール</strong>" },
                { "topic": "フランス革命", "q": "フランス革命後、ヨーロッパを席巻した軍事指導者は？", "a": "<strong>ナポレオン</strong>" },
                { "topic": "産業革命", "q": "18世紀後半にイギリスで始まった、機械化による生産革命は？", "a": "<strong>産業革命</strong>" },
                { "topic": "産業革命", "q": "産業革命で最初に革新が起こった産業部門は？", "a": "<strong>綿工業</strong>" },
                { "topic": "産業革命", "q": "蒸気機関を改良し、実用化した人物は？", "a": "<strong>ジェームズ・ワット</strong>" },
                { "topic": "産業革命", "q": "産業革命により形成された、工場労働者階級を何と呼ぶか？", "a": "<strong>プロレタリアート</strong>" }
            ];

        document.addEventListener('DOMContentLoaded', () => {
            const App = {
                state: {
                    cardData: [],
                    cardMemory: [], // { id, level, lastReview, nextReview }
                    studyQueue: [],
                    currentIndex: 0,
                    currentCard: null,
                    startTime: null,
                    studyTimer: null,
                    currentMode: 'ultra', // 'ultra' or 'spaced'
                },
                dom: {},
                config: {
                    STORAGE_KEY: 'ultraSpeedMemory_v1',
                    // 間隔反復の科学的間隔（分）
                    SPACED_INTERVALS: [2, 10, 30, 60, 240], // 2分、10分、30分、1時間、4時間後
                    MEMORY_LEVELS: {
                        UNKNOWN: 0,      // 未知：赤色
                        LEARNING: 1,     // 学習中：黄色
                        FAMILIAR: 2,     // 慣れた：緑色  
                        MEMORIZED: 3     // 記憶済み：青色
                    },
                    // 高速学習モード（スピーディー設定）
                    ULTRA_SPEED_DURATION: 8000,  // 8秒でフリップ（読み3秒＋考える5秒）
                    ANSWER_DISPLAY_TIME: 3000,   // 3秒間答えを表示（復習時間）
                    THINKING_TIME: 5000,         // 5秒の思考時間
                    // 科学的暗記支援設定（エビングハウスの忘却曲線・分散学習効果）
                    RECALL_TEST_PROBABILITY: 0.4, // 40%の確率で思い出しテスト
                    SELF_EXPLANATION_PROMPTS: [
                        "🤔 この答えの理由や背景を30秒で説明してみてください",
                        "📍 この場所の地理的特徴は何でしょうか？",
                        "🔗 他の地域や出来事との関連性を考えてみてください",
                        "💡 覚えるためのキーワードやイメージを作ってみてください",
                        "📚 この問題のポイントを自分の言葉で要約してください"
                    ],
                    // 視覚的記憶支援（デュアルコーディング理論）
                    VISUAL_CUES: {
                        DIFFICULTY_COLORS: {
                            easy: '#4CAF50',   // 緑：簡単
                            medium: '#FF9800', // オレンジ：普通
                            hard: '#f44336'    // 赤：難しい
                        },
                        MEMORY_PROGRESS_COLORS: ['#ff4444', '#ff8800', '#44aa44', '#0088ff']
                    },
                    // 記憶定着促進設定
                    ELABORATIVE_REHEARSAL_CHANCE: 0.3, // 30%で詳細リハーサル
                    CONFIDENCE_TRACKING: true,          // 自信度追跡
                    DISTRIBUTED_PRACTICE_REMINDERS: true // 分散学習リマインダー
                },

                init() {
                    this.cacheDOM();
                    this.state.cardData = initialCardData.map((card, index) => ({ ...card, id: index }));
                    this.loadMemoryData();
                    this.updateDashboard();
                    this.bindEvents();
                    this.showDashboard();
                },

                cacheDOM() {
                    this.dom = {
                        dashboard: document.getElementById('dashboard'),
                        studyScreen: document.getElementById('study-screen'),
                        progressInfo: document.getElementById('progress-info'),
                        studyTimer: document.getElementById('study-timer'),
                        card: document.getElementById('card'),
                        cardInner: document.getElementById('card-inner'),
                        frontTopicTag: document.getElementById('front-topic-tag'),
                        backTopicTag: document.getElementById('back-topic-tag'),
                        question: document.getElementById('question'),
                        answer: document.getElementById('answer'),
                        speedIndicator: document.getElementById('speed-indicator'),
                        memoryIndicator: document.getElementById('memory-indicator'),
                        evalContainer: document.getElementById('eval-container'),
                        evalStep1: document.getElementById('eval-step-1'),
                        evalUnknownBtn: document.getElementById('eval-unknown'),
                        evalInstantBtn: document.getElementById('eval-instant'),
                        ultraSpeedBtn: document.getElementById('ultra-speed-btn'),
                        reviewCycleBtn: document.getElementById('review-cycle-btn'),
                        resetProgressBtn: document.getElementById('reset-progress'),
                        backToDashBtn: document.getElementById('back-to-dash'),
                    };
                },

                bindEvents() {
                    this.dom.ultraSpeedBtn.addEventListener('click', () => this.startUltraSpeed());
                    this.dom.reviewCycleBtn.addEventListener('click', () => this.startSpacedReview());
                    this.dom.resetProgressBtn.addEventListener('click', () => this.resetProgress());
                    this.dom.backToDashBtn.addEventListener('click', () => this.showDashboard());
                    this.dom.card.addEventListener('click', () => this.flipCard());
                    
                    // 評価ボタンのイベントリスナーを確実に設定（複数回設定を防ぐ）
                    this.bindEvaluationButtons();
                },

                bindEvaluationButtons() {
                    // 既存のリスナーを削除してから再設定
                    const newUnknownBtn = this.dom.evalUnknownBtn.cloneNode(true);
                    const newInstantBtn = this.dom.evalInstantBtn.cloneNode(true);
                    
                    this.dom.evalUnknownBtn.parentNode.replaceChild(newUnknownBtn, this.dom.evalUnknownBtn);
                    this.dom.evalInstantBtn.parentNode.replaceChild(newInstantBtn, this.dom.evalInstantBtn);
                    
                    this.dom.evalUnknownBtn = newUnknownBtn;
                    this.dom.evalInstantBtn = newInstantBtn;
                    
                    this.dom.evalUnknownBtn.addEventListener('click', (e) => {
                        console.log('Unknown button clicked');
                        e.preventDefault();
                        e.stopPropagation();
                        this.handleEvaluation('unknown');
                    });
                    
                    this.dom.evalInstantBtn.addEventListener('click', (e) => {
                        console.log('Instant button clicked');
                        e.preventDefault();
                        e.stopPropagation();
                        this.handleEvaluation('instant');
                    });
                },

                handleEvaluation(type) {
                    // 評価ボタンを一時的に無効化して重複クリックを防ぐ
                    this.dom.evalUnknownBtn.disabled = true;
                    this.dom.evalInstantBtn.disabled = true;
                    
                    this.evaluate(type);
                    
                    // 200ms後にボタンを再有効化
                    setTimeout(() => {
                        this.dom.evalUnknownBtn.disabled = false;
                        this.dom.evalInstantBtn.disabled = false;
                    }, 200);
                },

                startTimer() {
                    this.state.startTime = Date.now();
                    this.state.studyTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - this.state.startTime) / 1000);
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        this.dom.studyTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }, 1000);
                },

                stopTimer() {
                    if (this.state.studyTimer) {
                        clearInterval(this.state.studyTimer);
                        this.state.studyTimer = null;
                    }
                },

                loadMemoryData() {
                    let savedData;
                    try {
                        savedData = JSON.parse(localStorage.getItem(this.config.STORAGE_KEY));
                        if (!Array.isArray(savedData) || savedData.length !== this.state.cardData.length) {
                            savedData = null;
                        }
                    } catch (e) { 
                        savedData = null; 
                    }
                    
                    this.state.cardMemory = savedData || this.state.cardData.map(c => ({
                        id: c.id,
                        level: this.config.MEMORY_LEVELS.UNKNOWN,
                        lastReview: 0,
                        nextReview: 0
                    }));
                    this.saveMemoryData();
                },

                saveMemoryData() {
                    localStorage.setItem(this.config.STORAGE_KEY, JSON.stringify(this.state.cardMemory));
                },

                resetProgress() {
                    if (confirm('⚠️ すべての学習記録がリセットされます。よろしいですか？')) {
                        this.state.cardMemory = this.state.cardData.map(c => ({
                            id: c.id,
                            level: this.config.MEMORY_LEVELS.UNKNOWN,
                            lastReview: 0,
                            nextReview: 0
                        }));
                        this.saveMemoryData();
                        this.updateDashboard();
                        alert('学習記録をリセットしました。');
                    }
                },

                updateDashboard() {
                    document.getElementById('total-value').textContent = this.state.cardData.length;
                    const memorizedCount = this.state.cardMemory.filter(m => m.level >= this.config.MEMORY_LEVELS.MEMORIZED).length;
                    const remainingCount = this.state.cardData.length - memorizedCount;
                    const progressPercentage = Math.round((memorizedCount / this.state.cardData.length) * 100);
                    
                    document.getElementById('remaining-value').textContent = remainingCount;
                    document.getElementById('memorized-value').textContent = memorizedCount;
                    document.getElementById('memory-percentage').textContent = progressPercentage + '%';
                },

                showDashboard() {
                    this.dom.dashboard.style.display = 'flex';
                    this.dom.studyScreen.style.display = 'none';
                    this.stopTimer();
                    this.updateDashboard();
                },

                startUltraSpeed() {
                    this.state.currentMode = 'ultra';
                    const unknownCards = this.state.cardMemory.filter(m => m.level === this.config.MEMORY_LEVELS.UNKNOWN);
                    
                    if (unknownCards.length === 0) {
                        alert("🎉 全問題を学習済みです！間隔反復復習に進みましょう。");
                        return;
                    }

                    this.state.studyQueue = this.shuffleArray(unknownCards.map(c => c.id));
                    this.state.currentIndex = 0;
                    this.startStudySession();
                },

                startSpacedReview() {
                    this.state.currentMode = 'spaced';
                    const now = Date.now();
                    const reviewCards = this.state.cardMemory.filter(m => 
                        m.level > this.config.MEMORY_LEVELS.UNKNOWN && 
                        m.level < this.config.MEMORY_LEVELS.MEMORIZED &&
                        m.nextReview <= now
                    );
                    
                    if (reviewCards.length === 0) {
                        alert("🎉 復習の必要なカードはありません！新しい学習を始めましょう。");
                        return;
                    }

                    this.state.studyQueue = reviewCards.map(c => c.id);
                    this.state.currentIndex = 0;
                    this.startStudySession();
                },

                startStudySession() {
                    this.dom.dashboard.style.display = 'none';
                    this.dom.studyScreen.style.display = 'flex';
                    this.startTimer();
                    this.renderCard(this.state.studyQueue[0]);
                },

                createInterleavedQueue(cardIds) {
                    const groupedByTopic = {};
                    cardIds.forEach(id => {
                        const topic = this.state.cardData[id].topic.split('/')[0];
                        if (!groupedByTopic[topic]) groupedByTopic[topic] = [];
                        groupedByTopic[topic].push(id);
                    });

                    for (const topic in groupedByTopic) this.shuffleArray(groupedByTopic[topic]);

                    const interleavedQueue = [];
                    const topics = Object.keys(groupedByTopic);
                    let lastTopic = null;

                    while (interleavedQueue.length < cardIds.length) {
                        let availableTopics = topics.filter(t => groupedByTopic[t].length > 0 && t !== lastTopic);
                        if (availableTopics.length === 0) {
                            availableTopics = topics.filter(t => groupedByTopic[t].length > 0);
                        }
                        const nextTopic = availableTopics[Math.floor(Math.random() * availableTopics.length)];
                        interleavedQueue.push(groupedByTopic[nextTopic].shift());
                        lastTopic = nextTopic;
                    }
                    return interleavedQueue;
                },

                renderCard(cardId) {
                    this.state.currentCard = this.state.cardData.find(c => c.id === cardId);
                    const { topic, q, a } = this.state.currentCard;
                    const memory = this.state.cardMemory.find(m => m.id === cardId);
                    
                    // カード開始時間を記録（学習時間追跡用）
                    this.state.cardStartTime = Date.now();

                    // 科学的暗記支援：思い出しテスト実装（テスト効果）
                    const shouldDoRecallTest = Math.random() < this.config.RECALL_TEST_PROBABILITY;
                    
                    // 記憶レベル表示更新
                    this.updateMemoryIndicator(memory.level);
                    
                    this.dom.frontTopicTag.textContent = topic;
                    this.dom.backTopicTag.textContent = topic;
                    
                    if (shouldDoRecallTest && this.state.currentMode === 'ultra') {
                        this.dom.question.innerHTML = `
                            <div class="recall-test">
                                <div class="recall-prompt">🧠 アクティブリコール</div>
                                <div class="recall-question">まず答えを思い浮かべてください：<br><strong>「${q}」</strong></div>
                                <div class="recall-hint">（3秒後に通常問題が表示されます）</div>
                                <div class="recall-benefit">※思い出すプロセスが記憶を強化します</div>
                            </div>
                        `;
                        setTimeout(() => {
                            this.dom.question.textContent = q;
                        }, 3000); // 3秒に短縮
                    } else {
                        this.dom.question.textContent = q;
                    }
                    
                    // 記憶レベルに応じた視覚的フィードバック（デュアルコーディング理論）
                    const difficultyLevel = this.getDifficultyLevel(memory.level);
                    this.dom.card.style.borderLeft = `5px solid ${this.config.VISUAL_CUES.DIFFICULTY_COLORS[difficultyLevel]}`;
                    this.dom.card.style.backgroundColor = this.getCardBackgroundColor(memory.level);
                    
                    this.dom.answer.innerHTML = a;

                    // 進捗情報更新
                    this.dom.progressInfo.textContent = `残り ${this.state.studyQueue.length - this.state.currentIndex} 問 (進捗: ${Math.round((this.state.currentIndex / this.state.studyQueue.length) * 100)}%)`;

                    // カード状態の完全リセット
                    this.dom.card.classList.remove('is-flipped');
                    this.dom.evalContainer.classList.remove('show');
                    this.dom.evalStep1.classList.remove('active');
                    
                    // スピードインジケーターをリセット
                    this.dom.speedIndicator.style.background = 'var(--success-color)';
                    
                    // 超高速モードでは自動でカウントダウン（スピーディー設定）
                    if (this.state.currentMode === 'ultra') {
                        const flipDuration = shouldDoRecallTest ? 
                            this.config.ULTRA_SPEED_DURATION + 3000 : // リコールテストの場合は+3秒
                            this.config.ULTRA_SPEED_DURATION;
                        this.startAutoFlip(flipDuration);
                    } else {
                        // 間隔反復モードでは手動フリップ
                        this.dom.speedIndicator.textContent = 'タップして答えを確認';
                        this.dom.speedIndicator.style.background = 'var(--primary-color)';
                    }
                },

                updateMemoryIndicator(level) {
                    this.dom.memoryIndicator.className = `memory-level-indicator memory-level-${level}`;
                    const levelNames = ['未知', '学習中', '慣れた', '記憶済み'];
                    this.dom.memoryIndicator.title = `記憶レベル: ${levelNames[level]}`;
                },

                getCardBackgroundColor(level) {
                    const baseColor = 'var(--card-bg)';
                    const levelColors = {
                        0: 'linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 68, 68, 0.1) 100%)',
                        1: 'linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 136, 0, 0.1) 100%)',
                        2: 'linear-gradient(135deg, var(--card-bg) 0%, rgba(68, 170, 68, 0.1) 100%)',
                        3: 'linear-gradient(135deg, var(--card-bg) 0%, rgba(0, 136, 255, 0.1) 100%)'
                    };
                    return levelColors[level] || baseColor;
                },

                getDifficultyLevel(memoryLevel) {
                    if (memoryLevel <= this.config.MEMORY_LEVELS.UNKNOWN) return 'hard';
                    if (memoryLevel <= this.config.MEMORY_LEVELS.LEARNING) return 'medium';
                    return 'easy';
                },

                startAutoFlip(duration = this.config.ULTRA_SPEED_DURATION) {
                    let countdown = Math.floor(duration / 1000);
                    
                    // より親切なカウントダウン表示
                    this.dom.speedIndicator.textContent = `考える時間: ${countdown}秒`;
                    this.dom.speedIndicator.className = 'speed-indicator ultra-fast';
                    
                    // フェーズ表示を追加
                    const phases = {
                        reading: Math.floor(countdown * 0.4),  // 読解フェーズ（40%）
                        thinking: Math.floor(countdown * 0.6)  // 思考フェーズ（60%）
                    };
                    
                    const timer = setInterval(() => {
                        countdown--;
                        
                        if (countdown > phases.thinking) {
                            this.dom.speedIndicator.textContent = `📖 読解時間: ${countdown}秒`;
                            this.dom.speedIndicator.style.background = 'var(--primary-color)';
                        } else if (countdown > 0) {
                            this.dom.speedIndicator.textContent = `🤔 思考時間: ${countdown}秒`;
                            this.dom.speedIndicator.style.background = 'var(--warning-color)';
                        } else {
                            this.dom.speedIndicator.textContent = '✅ 答え確認';
                            this.dom.speedIndicator.style.background = 'var(--success-color)';
                        }
                        
                        if (countdown === 0) {
                            clearInterval(timer);
                            this.flipCard();
                        }
                    }, 1000);
                },

                flipCard() {
                    if (this.dom.card.classList.contains('is-flipped')) return;
                    this.dom.card.classList.add('is-flipped');
                    
                    // 科学的暗記支援：自己説明促進機能（精緻化リハーサル）
                    const memory = this.state.cardMemory.find(m => m.id === this.state.currentCard.id);
                    const shouldPromptExplanation = memory.level <= this.config.MEMORY_LEVELS.LEARNING && 
                        Math.random() < this.config.ELABORATIVE_REHEARSAL_CHANCE;
                    
                    if (shouldPromptExplanation) {
                        const prompt = this.config.SELF_EXPLANATION_PROMPTS[
                            Math.floor(Math.random() * this.config.SELF_EXPLANATION_PROMPTS.length)
                        ];
                        this.showSelfExplanationPrompt(prompt);
                    }
                    
                    this.dom.speedIndicator.textContent = '💡 記憶を定着させています...';
                    this.dom.speedIndicator.style.background = 'var(--success-color)';
                    
                    // 評価ボタンを素早く表示するための処理
                    setTimeout(() => {
                        this.showEvaluationButtons();
                    }, 1000); // 1秒後に素早く表示
                },

                showEvaluationButtons() {
                    // 評価ボタンの確実な表示
                    this.dom.evalContainer.classList.add('show');
                    this.dom.evalStep1.classList.add('active');
                    console.log('Evaluation buttons shown');
                    
                    // インジケーターの更新
                    this.dom.speedIndicator.textContent = '⚡ 評価してください';
                    this.dom.speedIndicator.style.background = 'var(--warning-color)';
                },

                getAnswerDisplayTime(memoryLevel) {
                    // スピーディー設定：記憶レベルが低いほど少し長く表示
                    const baseTimes = [4000, 3000, 2000, 1500]; // レベル別表示時間（高速化）
                    return baseTimes[memoryLevel] || 2000;
                },

                scheduleEvaluationPrompt(delay) {
                    setTimeout(() => {
                        this.showEvaluationButtons();
                    }, delay);
                },

                showSelfExplanationPrompt(prompt) {
                    const explanationDiv = document.createElement('div');
                    explanationDiv.className = 'self-explanation-prompt';
                    explanationDiv.innerHTML = `
                        <div class="explanation-header">🎯 記憶強化タイム</div>
                        <div class="explanation-text">${prompt}</div>
                        <div class="explanation-timer">
                            <div class="timer-bar">
                                <div class="timer-fill"></div>
                            </div>
                            思考中... この時間が記憶を強化します
                        </div>
                    `;
                    
                    this.dom.answer.appendChild(explanationDiv);
                    
                    // アニメーション付きタイマーバー（高速化）
                    const timerFill = explanationDiv.querySelector('.timer-fill');
                    if (timerFill) {
                        timerFill.style.animation = 'timer-progress 5s linear forwards';
                    }
                    
                    setTimeout(() => {
                        if (explanationDiv.parentNode) {
                            explanationDiv.style.opacity = '0';
                            explanationDiv.style.transform = 'translateY(-20px)';
                            setTimeout(() => explanationDiv.remove(), 200);
                        }
                    }, 5000); // 5秒に短縮
                },

                evaluate(type) {
                    console.log('Evaluate called with type:', type);
                    const cardMemory = this.state.cardMemory.find(m => m.id === this.state.currentCard.id);
                    const now = Date.now();
                    
                    // 科学的記憶評価システム
                    if (type === 'instant') {
                        // 瞬時に答えが浮かんだ場合（流暢性効果）
                        cardMemory.level = Math.min(cardMemory.level + 1, this.config.MEMORY_LEVELS.MEMORIZED);
                        cardMemory.confidenceScore = (cardMemory.confidenceScore || 0) + 0.3;
                        
                        if (cardMemory.level < this.config.MEMORY_LEVELS.MEMORIZED) {
                            // 次の復習時間を設定（改良された間隔反復）
                            const intervalMinutes = this.config.SPACED_INTERVALS[cardMemory.level - 1] || 60;
                            cardMemory.nextReview = now + (intervalMinutes * 60 * 1000);
                        }
                        
                        // ポジティブフィードバック
                        this.showFeedback('✅ 素晴らしい！記憶が定着しています', 'success');
                        
                    } else if (type === 'unknown') {
                        // 分からなかった場合（忘却曲線対策）
                        cardMemory.level = Math.max(cardMemory.level - 1, this.config.MEMORY_LEVELS.UNKNOWN);
                        cardMemory.confidenceScore = Math.max((cardMemory.confidenceScore || 0) - 0.2, 0);
                        cardMemory.nextReview = now + (2 * 60 * 1000); // 2分後に再復習
                        
                        // 学習促進フィードバック
                        this.showFeedback('📚 大丈夫！再学習で記憶を強化します', 'info');
                    }
                    
                    // メタ認知追跡
                    cardMemory.reviewCount = (cardMemory.reviewCount || 0) + 1;
                    cardMemory.lastReview = now;
                    cardMemory.totalStudyTime = (cardMemory.totalStudyTime || 0) + 
                        (now - (this.state.cardStartTime || now));
                    
                    this.saveMemoryData();
                    this.proceedToNextCard();
                },

                showFeedback(message, type) {
                    const feedbackDiv = document.createElement('div');
                    feedbackDiv.className = `feedback-message ${type}`;
                    feedbackDiv.textContent = message;
                    
                    document.body.appendChild(feedbackDiv);
                    
                    setTimeout(() => {
                        feedbackDiv.style.opacity = '0';
                        feedbackDiv.style.transform = 'translateY(-20px)';
                        setTimeout(() => feedbackDiv.remove(), 300);
                    }, 2000);
                },

                proceedToNextCard() {
                    this.state.currentIndex++;
                    
                    // 評価コンテナを確実に非表示にする
                    this.dom.evalContainer.classList.remove('show');
                    this.dom.evalStep1.classList.remove('active');
                    
                    // スピードインジケーターをリセット
                    this.dom.speedIndicator.textContent = '次のカードを準備中...';
                    this.dom.speedIndicator.style.background = 'var(--primary-color)';

                    if (this.state.currentIndex < this.state.studyQueue.length) {
                        const nextCardId = this.state.studyQueue[this.state.currentIndex];
                        
                        // カード遷移アニメーション（高速化）
                        this.dom.cardInner.style.opacity = 0;
                        this.dom.cardInner.style.transform = 'scale(0.95)';
                        
                        setTimeout(() => {
                            this.renderCard(nextCardId);
                            this.dom.cardInner.style.opacity = 1;
                            this.dom.cardInner.style.transform = 'scale(1)';
                        }, 100); // 100msで超高速化
                    } else {
                        // セッション完了処理
                        setTimeout(() => {
                            this.showSessionResults();
                        }, 300);
                    }
                },

                showSessionResults() {
                    const memorizedCount = this.state.cardMemory.filter(m => m.level >= this.config.MEMORY_LEVELS.MEMORIZED).length;
                    const totalTime = Math.floor((Date.now() - this.state.startTime) / 1000);
                    const minutes = Math.floor(totalTime / 60);
                    const seconds = totalTime % 60;
                    const progressPercentage = Math.round((memorizedCount / this.state.cardData.length) * 100);
                    
                    let message = "🎉 学習セッション完了！\n\n";
                    message += `学習時間: ${minutes}分${seconds}秒\n`;
                    message += `記憶率: ${progressPercentage}%\n`;
                    message += `記憶済み: ${memorizedCount}問\n\n`;
                    
                    if (this.state.currentMode === 'ultra') {
                        message += "次は間隔反復復習で記憶を定着させましょう！";
                    } else {
                        message += "素晴らしい！継続的な復習で長期記憶に移行中です！";
                    }
                    
                    alert(message);
                    this.showDashboard();
                },

                shuffleArray(array) {
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                    return array;
                }
            };

            App.init();
        });
    </script>
</body>

</html>