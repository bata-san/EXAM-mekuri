<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åœ°ç† æœ€çµ‚æ±ºæˆ¦ãƒ¢ãƒ¼ãƒ‰ (Zettelkasten Edition)</title>
    <style>
        :root {
            --bg-color: #f0f2f5; --card-bg: #ffffff; --primary-color: #007bff;
            --success-color: #28a745; --danger-color: #dc3545;
            --text-color: #212529; --shadow-color: rgba(0, 0, 0, 0.12);
        }
        html, body { 
            height: 100%; margin: 0; padding: 0; overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
        }
        .app-container { 
            display: flex; flex-direction: column; height: 100%; 
            background-color: var(--bg-color); 
        }
        
        /* Dashboard Screen */
        #dashboard { 
            display: flex; flex-direction: column; justify-content: center; 
            align-items: center; height: 100%; padding: 20px; box-sizing: border-box; 
        }
        #dashboard h1 { color: var(--primary-color); margin-bottom: 20px; font-size: 28px; }
        .stats-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; 
            width: 100%; max-width: 400px; margin: 20px 0; 
        }
        .stat-box { 
            background: var(--card-bg); padding: 15px; border-radius: 12px; 
            text-align: center; box-shadow: 0 4px 12px var(--shadow-color); 
        }
        .stat-box .label { font-size: 14px; color: #6c757d; margin-bottom: 5px; }
        .stat-box .value { font-size: 28px; font-weight: bold; }
        #review-value { color: var(--danger-color); }
        #mastered-value { color: var(--success-color); }
        .start-btn { 
            width: 100%; max-width: 400px; padding: 15px; font-size: 18px; 
            font-weight: bold; cursor: pointer; border: none; border-radius: 12px; 
            background-color: var(--primary-color); color: white; margin-top: 10px; 
            transition: background-color 0.2s;
        }
        .start-btn:hover { background-color: #0056b3; }
        .start-btn:active { transform: translateY(1px); }
        
        /* Study Screen */
        #study-screen { 
            display: none; flex-direction: column; height: 100%; 
        }
        .study-header { 
            padding: 15px; text-align: center; background: var(--card-bg); 
            box-shadow: 0 2px 4px var(--shadow-color); z-index: 10; 
            position: relative;
        }
        .progress-info { 
            font-size: 16px; font-weight: 600; color: var(--primary-color); 
        }
        #back-to-queue-btn {
            position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
            background: var(--primary-color); color: white; padding: 6px 12px;
            border-radius: 20px; font-size: 12px; font-weight: bold;
            cursor: pointer; display: none; /* Initially hidden */
        }
        
        /* Card Area */
        .card-area { 
            flex-grow: 1; display: flex; justify-content: center; 
            align-items: center; padding: 20px; overflow: hidden; 
            position: relative;
        }
        
        /* Card Styles */
        .card { 
            width: 100%; max-width: 400px; height: 420px; /* é«˜ã•ã‚’å¢—ã‚„ã™ */
            perspective: 1000px; cursor: pointer; user-select: none;
        }
        .card-inner { 
            position: relative; width: 100%; height: 100%; 
            transform-style: preserve-3d; transition: transform 0.6s ease, opacity 0.3s ease;
            border-radius: 15px; box-shadow: 0 8px 25px var(--shadow-color);
        }
        .card.is-flipped .card-inner { 
            transform: rotateY(180deg); 
        }
        .card-face { 
            position: absolute; width: 100%; height: 100%; 
            backface-visibility: hidden; border-radius: 15px;
            display: flex; flex-direction: column; justify-content: center; 
            align-items: center; padding: 25px; box-sizing: border-box;
            background: var(--card-bg); text-align: center;
        }
        .card-back { 
            transform: rotateY(180deg); 
            justify-content: flex-start; /* ä¸Šã‹ã‚‰é…ç½® */
            padding-top: 30px;
        }
        
        /* Card Content */
        .topic-tag { 
            position: absolute; top: 15px; left: 15px; 
            background: rgba(0, 123, 255, 0.1); color: var(--primary-color); 
            font-size: 12px; padding: 6px 12px; border-radius: 20px; 
            font-weight: 600;
        }
        .question { 
            font-size: 18px; font-weight: 600; line-height: 1.4; 
            color: var(--text-color); margin-top: 10px;
        }
        .answer { 
            font-size: 20px; font-weight: bold; line-height: 1.3; 
            color: var(--text-color); margin-bottom: 20px;
        }

        /* Related Cards Section */
        .related-cards-container {
            margin-top: 15px;
            width: 100%;
            text-align: left;
        }
        .related-cards-container h4 {
            font-size: 14px;
            color: #6c757d;
            margin: 0 0 10px 0;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 5px;
        }
        .related-cards-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 180px; /* é«˜ã•ã«åˆ¶é™ã‚’è¨­ã‘ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            overflow-y: auto;
        }
        .related-card-btn {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            color: var(--primary-color);
            padding: 8px 12px;
            border-radius: 8px;
            text-align: left;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            box-sizing: border-box;
        }
        .related-card-btn:hover {
            background-color: #e9ecef;
        }
        
        /* Card Status Borders */
        .card-inner[data-status='review'] { border: 4px solid var(--danger-color); }
        .card-inner[data-status='mastered'] { border: 4px solid var(--success-color); }
        .card-inner[data-status='unseen'] { border: 4px solid #e9ecef; }
        
        /* Evaluation Buttons */
        .eval-footer { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            padding: 20px; background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px); z-index: 100;
            display: none; justify-content: space-between; gap: 15px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }
        .eval-footer.show { 
            display: flex; 
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .eval-btn { 
            flex: 1; padding: 15px; font-size: 16px; font-weight: bold; 
            border: none; border-radius: 12px; cursor: pointer;
            transition: all 0.2s ease;
        }
        .eval-btn:active { transform: translateY(1px); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #218838; }
        
        /* Back Button */
        #back-to-dash { 
            position: fixed; top: 15px; right: 15px; z-index: 200; 
            background: rgba(0,0,0,0.6); color: white; border-radius: 50%; 
            width: 40px; height: 40px; display: flex; justify-content: center; 
            align-items: center; font-weight: bold; cursor: pointer; 
        }
        
        strong { color: #d63384; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Dashboard Screen -->
        <div id="dashboard">
            <h1>åœ°ç† æœ€çµ‚æ±ºæˆ¦</h1>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="label">å…¨å•é¡Œæ•°</div>
                    <div class="value" id="total-value">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">æœªå­¦ç¿’</div>
                    <div class="value" id="unseen-value">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">è‹¦æ‰‹</div>
                    <div class="value" id="review-value">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">å®Œç’§</div>
                    <div class="value" id="mastered-value">0</div>
                </div>
            </div>
            <button class="start-btn" id="start-all-btn">1å‘¨ç›®ã‚¹ã‚¿ãƒ¼ãƒˆ (å…¨ç¯„å›²)</button>
            <button class="start-btn" id="start-review-btn" style="background-color: #dc3545;">è‹¦æ‰‹ã ã‘ã‚’æ½°ã™</button>
            <button class="start-btn" id="reset-progress" style="margin-top:20px; background-color: #6c757d; font-size: 14px;">å­¦ç¿’è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <!-- Study Screen -->
        <div id="study-screen">
            <div class="study-header">
                <div id="back-to-queue-btn">â† å­¦ç¿’ã«æˆ»ã‚‹</div>
                <div class="progress-info" id="progress-info"></div>
            </div>
            <div class="card-area" id="card-area"></div>
            <div id="back-to-dash" title="ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹">âœ•</div>
            
            <div class="eval-footer" id="eval-footer">
                <button class="eval-btn btn-danger" id="eval-review">è‹¦æ‰‹</button>
                <button class="eval-btn btn-success" id="eval-mastered">å®Œç’§</button>
            </div>
        </div>
    </div>

    <script>
    // === ãƒ‡ãƒ¼ã‚¿å®šç¾© (é–¢é€£ã‚«ãƒ¼ãƒ‰IDã‚’è¿½åŠ ) ===
    const initialCardData = [ 
        { topic: "åœ°å½¢", q: "æ°·æ²³ã®ä¾µé£Ÿã§ã§ããŸUå­—è°·ã«æµ·æ°´ãŒä¾µå…¥ã—ã¦ã§ããŸæµ·å²¸åœ°å½¢ã¯ï¼Ÿ", a: "<strong>ãƒ•ã‚£ãƒ¨ãƒ«ãƒ‰</strong>", related: [1, 2] },
        { topic: "åœ°å½¢", q: "æ°·æ²³ãŒå±±é ‚ä»˜è¿‘ã‚’å‰Šã£ã¦ã§ããŸã€ãŠæ¤€å‹ã®è°·ã‚’ä½•ã¨ã„ã†ã‹ï¼Ÿ", a: "<strong>ã‚«ãƒ¼ãƒ«ï¼ˆåœè°·ï¼‰</strong>", related: [0, 2] },
        { topic: "åœ°å½¢", q: "æ°·æ²³ãŒé‹ã‚“ã åœŸç ‚ãŒå †ç©ã—ã¦ã§ããŸä¸˜ã‚’ä½•ã¨å‘¼ã¶ã‹ï¼Ÿ", a: "<strong>ãƒ¢ãƒ¬ãƒ¼ãƒ³</strong>", related: [0, 1] },
        { topic: "åœ°å½¢", q: "æ²³å·ãŒå±±åœ°ã‹ã‚‰å¹³é‡ã«å‡ºã‚‹æ‰€ã«ã§ãã‚‹ã€æ‰‡çŠ¶ã®åœ°å½¢ã¯ï¼Ÿ", a: "<strong>æ‰‡çŠ¶åœ°</strong>", related: [4, 5, 6] },
        { topic: "åœ°å½¢", q: "æ‰‡çŠ¶åœ°ã®ä¸­å¤®éƒ¨ï¼ˆæ‰‡å¤®ï¼‰ã§ã‚ˆãè¦‹ã‚‰ã‚Œã‚‹ã€æ™®æ®µã¯æ°´ãŒæµã‚Œãªã„å·ã¯ï¼Ÿ", a: "<strong>æ°´ç„¡å·</strong>", related: [3, 5] },
        { topic: "åœ°å½¢", q: "æ‰‡çŠ¶åœ°ã®æœ«ç«¯ï¼ˆæ‰‡ç«¯ï¼‰ã§ã¯ã€ä½•ãŒæ¹§ãå‡ºã™ãŸã‚é›†è½ãŒç™ºé”ã—ã‚„ã™ã„ã‹ï¼Ÿ", a: "<strong>æ¹§æ°´</strong>", related: [3, 4] },
        { topic: "åœ°å½¢", q: "æ²³å·ãŒè›‡è¡Œã™ã‚‹ä¸‹æµéƒ¨ã«å½¢æˆã•ã‚Œã‚‹å¹³é‡ã‚’ä½•ã¨å‘¼ã¶ã‹ï¼Ÿ", a: "<strong>æ°¾æ¿«åŸ</strong>", related: [7, 8, 9] },
        { topic: "åœ°å½¢", q: "æ°¾æ¿«åŸã«ãŠã„ã¦ã€æ´ªæ°´æ™‚ã«åœŸç ‚ãŒå †ç©ã—ã¦ã§ããŸå¾®é«˜åœ°ã¯ï¼Ÿ", a: "<strong>è‡ªç„¶å ¤é˜²</strong>", related: [6, 8] },
        { topic: "åœ°å½¢", q: "è‡ªç„¶å ¤é˜²ã®èƒŒå¾Œã«ã‚ã‚‹ã€æ°´ã¯ã‘ã®æ‚ªã„ä½æ¹¿åœ°ã‚’ä½•ã¨å‘¼ã¶ã‹ï¼Ÿ", a: "<strong>å¾ŒèƒŒæ¹¿åœ°</strong>", related: [6, 7] },
        { topic: "åœ°å½¢", q: "æ²³å·ã®è›‡è¡ŒãŒã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã•ã‚Œã€å–ã‚Šæ®‹ã•ã‚Œã¦ã§ããŸæ¹–ã¯ï¼Ÿ", a: "<strong>ä¸‰æ—¥æœˆæ¹–</strong>", related: [6] },
        { topic: "åœ°å½¢", q: "æ²³å£ä»˜è¿‘ã«é‹ã°ã‚ŒãŸåœŸç ‚ãŒå †ç©ã—ã¦ã§ãã‚‹ä¸‰è§’å½¢ã®åœ°å½¢ã¯ï¼Ÿ", a: "<strong>ä¸‰è§’å·ï¼ˆãƒ‡ãƒ«ã‚¿ï¼‰</strong>" },
        { topic: "åœ°å½¢", q: "ç¡¬ã„æ°´å¹³ãªåœ°å±¤ãŒä¾µé£Ÿã‹ã‚‰æ®‹ã£ã¦ã§ããŸãƒ†ãƒ¼ãƒ–ãƒ«çŠ¶ã®åœ°å½¢ã¯ï¼Ÿ", a: "<strong>ãƒ¡ã‚µ</strong>", related: [12] },
        { topic: "åœ°å½¢", q: "ãƒ¡ã‚µãŒã•ã‚‰ã«ä¾µé£Ÿã•ã‚Œã¦ã§ããŸã€å­¤ç«‹ã—ãŸå²©å±±ã¯ï¼Ÿ", a: "<strong>ãƒ“ãƒ¥ãƒ¼ãƒˆ</strong>", related: [11] },
        { topic: "åœ°å½¢", q: "çŸ³ç°å²©ãŒæ°´ã«æº¶é£Ÿã•ã‚Œã¦ã§ãã‚‹åœ°å½¢ã‚’ç·ç§°ã—ã¦ä½•ã¨ã„ã†ã‹ï¼Ÿ", a: "<strong>ã‚«ãƒ«ã‚¹ãƒˆåœ°å½¢</strong>", related: [14, 15, 16] },
        { topic: "åœ°å½¢", q: "ã‚«ãƒ«ã‚¹ãƒˆåœ°å½¢ã§è¦‹ã‚‰ã‚Œã‚‹ã€ã™ã‚Šé‰¢çŠ¶ã®ãã¼åœ°ã¯ï¼Ÿ", a: "<strong>ãƒ‰ãƒªãƒ¼ãƒ</strong>", related: [13, 15] },
        { topic: "åœ°å½¢", q: "ãƒ‰ãƒªãƒ¼ãƒãŒè¤‡æ•°ã¤ãªãŒã£ã¦ã§ããŸã€ã‚ˆã‚Šå¤§ããªãã¼åœ°ã¯ï¼Ÿ", a: "<strong>ã‚¦ãƒãƒ¼ãƒ¬</strong>", related: [13, 14] },
        { topic: "åœ°å½¢", q: "ã‚«ãƒ«ã‚¹ãƒˆåœ°å½¢ã®åœ°ä¸‹ã«è¦‹ã‚‰ã‚Œã‚‹ã€çŸ³ç°å²©ãŒæº¶ã‘ã¦ã§ããŸæ´çªŸã¯ï¼Ÿ", a: "<strong>é¾ä¹³æ´</strong>", related: [13] },
        { topic: "ç”Ÿæ´»ãƒ»æ¤ç”Ÿãƒ»åœŸå£Œ", q: "åœ°ä¸­æµ·æ²¿å²¸ã®çŸ³ç°å²©ãŒé¢¨åŒ–ã—ã¦ã§ããŸèµ¤è‰²ã®åœŸå£Œã¯ï¼Ÿ", a: "<strong>ãƒ†ãƒ©ãƒ­ãƒƒã‚µ</strong>", related: [13, 18] },
        { topic: "ç”Ÿæ´»ãƒ»æ¤ç”Ÿãƒ»åœŸå£Œ", q: "åœ°ä¸­æµ·æ€§æ°—å€™(Cs)ã®ä»£è¡¨çš„ãªè¾²æ¥­ã¨ã€ãã®ä½œç‰©2ã¤ã¯ï¼Ÿ", a: "<strong>åœ°ä¸­æµ·å¼è¾²æ¥­</strong> (<strong>ã‚ªãƒªãƒ¼ãƒ–</strong>, <strong>ãƒ–ãƒ‰ã‚¦</strong>ãªã©)", related: [17] },
        // ... ä»–ã®ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿
    ];

    document.addEventListener('DOMContentLoaded', () => {
        // IDã‚’è‡ªå‹•ä»˜ä¸ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§åˆ©ç”¨ã™ã‚‹
        const cardData = initialCardData.map((card, index) => ({ ...card, id: index }));

        const STORAGE_KEY = 'geoFinalBattleData_zettel_v2';
        let studyQueue = [];
        let currentIndex = 0;
        let cardStates = [];
        let currentCard = null;
        let isTransitioning = false;
        let studyContextStack = []; // ã‚¸ãƒ£ãƒ³ãƒ—å‰ã®çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹ã‚¹ã‚¿ãƒƒã‚¯

        const dashboard = document.getElementById('dashboard');
        const studyScreen = document.getElementById('study-screen');
        const cardArea = document.getElementById('card-area');
        const evalFooter = document.getElementById('eval-footer');
        const progressInfo = document.getElementById('progress-info');
        const backToQueueBtn = document.getElementById('back-to-queue-btn');

        // --- ä¿®æ­£: æœªå®šç¾©ã ã£ãŸé–¢æ•°ã‚’ã™ã¹ã¦å®šç¾© ---
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        const loadCardStates = () => {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // ä¿®æ­£: cardData.length ã‚’ä½¿ã†
                    if (Array.isArray(parsedData) && parsedData.length === cardData.length) {
                        cardStates = parsedData;
                        return;
                    }
                }
            } catch (e) { 
                console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e); 
            }
            initializeCardStates();
        };

        const initializeCardStates = () => {
            // ä¿®æ­£: cardData.map ã‚’ä½¿ã†
            cardStates = cardData.map((_, i) => ({ id: i, status: 'unseen' }));
            saveCardStates();
        };

        const saveCardStates = () => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(cardStates));
            } catch (e) {
                console.error("ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
            }
        };

        const updateDashboard = () => {
            // ä¿®æ­£: cardData.length ã‚’ä½¿ã†
            document.getElementById('total-value').textContent = cardData.length;
            document.getElementById('unseen-value').textContent = cardStates.filter(s => s.status === 'unseen').length;
            document.getElementById('review-value').textContent = cardStates.filter(s => s.status === 'review').length;
            document.getElementById('mastered-value').textContent = cardStates.filter(s => s.status === 'mastered').length;
        };

        const updateProgress = () => {
            if (studyContextStack.length > 0) {
                progressInfo.textContent = 'é–¢é€£ã‚«ãƒ¼ãƒ‰ã‚’å­¦ç¿’ä¸­...';
            } else if (studyQueue.length > 0) {
                progressInfo.textContent = `${currentIndex + 1} / ${studyQueue.length}`;
            } else {
                progressInfo.textContent = '';
            }
        };

        const startStudy = (filterType) => {
             if (filterType === 'all') {
                const reviewItems = cardStates.filter(s => s.status === 'review').map(s => s.id);
                const unseenItems = cardStates.filter(s => s.status === 'unseen').map(s => s.id);
                
                shuffleArray(reviewItems);
                shuffleArray(unseenItems);
                
                studyQueue = [...reviewItems, ...unseenItems];
            } else { // review
                studyQueue = cardStates.filter(s => s.status === 'review').map(s => s.id);
                shuffleArray(studyQueue);
            }
            
            if (studyQueue.length === 0) {
                const message = filterType === 'review' ? 
                    'ã€Œè‹¦æ‰‹ã€ã®ã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ï¼\nå…¨ç¯„å›²ã§å­¦ç¿’ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ' : 
                    'ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼å­¦ç¿’å¯¾è±¡ã®ã‚«ãƒ¼ãƒ‰ã¯å…¨ã¦å®Œç’§ã§ã™ã€‚';
                
                if (filterType === 'review' && cardStates.some(s => s.status === 'unseen')) {
                    if (confirm(message)) {
                        startStudy('all');
                    }
                } else {
                    alert(message);
                }
                return;
            }

            studyContextStack = []; // å­¦ç¿’é–‹å§‹æ™‚ã«ã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
            backToQueueBtn.style.display = 'none';
            currentIndex = 0;

            dashboard.style.display = 'none';
            studyScreen.style.display = 'flex';
            
            // ä¿®æ­£: æœ€åˆã®ã‚«ãƒ¼ãƒ‰ã‚’æ­£ã—ãè¡¨ç¤º
            renderCard(studyQueue[currentIndex]);
        };
        
        const renderCard = (cardId, isJump = false) => {
            if (cardId === undefined) {
                if (!isJump) showCompletionMessage();
                return;
            }

            // æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            const existingCard = cardArea.querySelector('.card');
            if (existingCard) {
                if (existingCard._eventCleanup) existingCard._eventCleanup();
                existingCard.remove();
            }
            
            evalFooter.classList.remove('show');
            if (isJump) {
                backToQueueBtn.style.display = 'block';
            }

            const state = cardStates[cardId];
            const data = cardData[cardId];
            
            const cardElement = document.createElement('div');
            cardElement.className = 'card';
            cardElement.innerHTML = `
                <div class="card-inner" data-status="${state.status}">
                    <div class="card-face card-front">
                        <span class="topic-tag">${data.topic}</span>
                        <div class="question">${data.q}</div>
                    </div>
                    <div class="card-face card-back">
                        <div class="answer">${data.a}</div>
                        <div class="related-cards-container">
                            <h4>é–¢é€£ã‚«ãƒ¼ãƒ‰</h4>
                            <div class="related-cards-list"></div>
                        </div>
                    </div>
                </div>
            `;
            
            cardArea.appendChild(cardElement);
            currentCard = cardElement;
            
            // ä¿®æ­£: setTimeout ã‚’ä½¿ã‚ãšã€ç›´æ¥ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            setupCardEvents(cardElement, cardId, isJump);
            updateProgress();
        };

        const setupCardEvents = (card, cardId, isJump) => {
            let isFlipped = false;
            let isProcessing = false;

            const handleCardClick = (e) => {
                e.preventDefault();
                if (isFlipped || isProcessing) return;
                
                isProcessing = true;
                card.classList.add('is-flipped');
                isFlipped = true;
                
                // ä¿®æ­£: setTimeoutã§ãƒ©ãƒƒãƒ—ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ã‚’å¾…ã¤
                setTimeout(() => {
                    if (!isJump) evalFooter.classList.add('show');
                    renderRelatedCards(cardId);
                    isProcessing = false;
                }, 300);
            };

            card.addEventListener('click', handleCardClick);
            card._eventCleanup = () => card.removeEventListener('click', handleCardClick);
        };

        const renderRelatedCards = (cardId) => {
            const listContainer = currentCard.querySelector('.related-cards-list');
            if (!listContainer) return;

            const currentData = cardData[cardId];
            let relatedIds = new Set(currentData.related || []);

            // ä¿®æ­£: åŒã˜ãƒˆãƒ”ãƒƒã‚¯ã®ã‚«ãƒ¼ãƒ‰ã‚‚é–¢é€£å€™è£œã«è¿½åŠ ï¼ˆæœ€å¤§3ä»¶ï¼‰
            cardData
                .filter(c => c.topic === currentData.topic && c.id !== cardId)
                .slice(0, 3)
                .forEach(c => relatedIds.add(c.id));

            if (relatedIds.size === 0) {
                listContainer.innerHTML = 'é–¢é€£ã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“';
                return;
            }

            listContainer.innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
            relatedIds.forEach(id => {
                const relatedData = cardData[id];
                if (relatedData) {
                    const btn = document.createElement('button');
                    btn.className = 'related-card-btn';
                    btn.textContent = relatedData.q;
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        jumpToCard(id);
                    };
                    listContainer.appendChild(btn);
                }
            });
        };

        const jumpToCard = (targetId) => {
            if (studyContextStack.length === 0) {
                studyContextStack.push({ queue: studyQueue, index: currentIndex });
            } else {
                // æ—¢ã«ã‚¸ãƒ£ãƒ³ãƒ—ä¸­ã®å ´åˆã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ã®ãƒˆãƒƒãƒ—ã‚’æ›´æ–°ã™ã‚‹ã ã‘
                // (ã‚¸ãƒ£ãƒ³ãƒ—ã®ã‚¸ãƒ£ãƒ³ãƒ—ã‹ã‚‰ã®æˆ»ã‚Šå…ˆã¯æœ€åˆã®ã‚¸ãƒ£ãƒ³ãƒ—å…ƒ)
            }
            renderCard(targetId, true);
        };

        backToQueueBtn.addEventListener('click', () => {
            const lastContext = studyContextStack.pop();
            if (lastContext) {
                studyQueue = lastContext.queue;
                currentIndex = lastContext.index;
                backToQueueBtn.style.display = 'none';
                renderCard(studyQueue[currentIndex]);
            }
        });

        const evaluateCard = (status) => {
            if (currentIndex >= studyQueue.length || isTransitioning) return;
            
            isTransitioning = true;
            const cardId = studyQueue[currentIndex];
            cardStates[cardId].status = status;
            saveCardStates();
            
            evalFooter.classList.remove('show');
            proceedToNextCard();
        };

        const proceedToNextCard = () => {
            currentIndex++;
            
            if (currentCard) {
                currentCard.querySelector('.card-inner').style.opacity = '0';
            }
            
            setTimeout(() => {
                isTransitioning = false;
                renderCard(studyQueue[currentIndex]);
            }, 250);
        };

        const showCompletionMessage = () => {
            const reviewCount = cardStates.filter(s => s.status === 'review').length;
            const masteredCount = cardStates.filter(s => s.status === 'mastered').length;
            
            let message = 'ğŸ‰ ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼\n\n';
            message += `å®Œç’§: ${masteredCount}å•\n`;
            message += `è‹¦æ‰‹: ${reviewCount}å•\n\n`;
            
            if (reviewCount > 0) {
                message += 'ã€Œè‹¦æ‰‹ã ã‘ã‚’æ½°ã™ã€ã§å¾©ç¿’ã—ã¾ã—ã‚‡ã†ï¼';
            } else {
                message += 'å…¨å•å®Œç’§ã§ã™ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼';
            }
            
            alert(message);
            showDashboard();
        };

        const showDashboard = () => {
            isTransitioning = false;
            studyContextStack = [];
            backToQueueBtn.style.display = 'none';
            dashboard.style.display = 'flex';
            studyScreen.style.display = 'none';
            evalFooter.classList.remove('show');
            updateDashboard();
            
            const existingCard = cardArea.querySelector('.card');
            if (existingCard) {
                if (existingCard._eventCleanup) existingCard._eventCleanup();
                existingCard.remove();
            }
            currentCard = null;
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.getElementById('start-all-btn').addEventListener('click', () => startStudy('all'));
        document.getElementById('start-review-btn').addEventListener('click', () => startStudy('review'));
        document.getElementById('back-to-dash').addEventListener('click', showDashboard);
        document.getElementById('reset-progress').addEventListener('click', () => {
            if (confirm('âš ï¸ è­¦å‘Š\n\nã™ã¹ã¦ã®å­¦ç¿’è¨˜éŒ²ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                initializeCardStates();
                updateDashboard();
                alert('å­¦ç¿’è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
            }
        });

        // ä¿®æ­£: ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…
        document.getElementById('eval-review').addEventListener('click', () => evaluateCard('review'));
        document.getElementById('eval-mastered').addEventListener('click', () => evaluateCard('mastered'));

        // åˆæœŸåŒ–
        loadCardStates();
        updateDashboard();
        showDashboard();
    });
    </script>
</body>
</html>