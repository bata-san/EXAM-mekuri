<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>地理 高密度エンコーディング・システム</title>
    <style>
        :root {
            --bg-color: #f4f6f9; --card-bg: #ffffff; --primary-color: #3b82f6;
            --success-color: #10b981; --danger-color: #ef4444; --warning-color: #f59e0b;
            --text-color: #1f2937; --sub-text-color: #6b7280; --shadow-color: rgba(0, 0, 0, 0.1);
        }
        html, body { 
            height: 100%; margin: 0; padding: 0; overflow: hidden; 
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
        }
        .app-container { display: flex; flex-direction: column; height: 100%; }
        
        /* Dashboard Screen */
        #dashboard { 
            display: flex; flex-direction: column; justify-content: center; 
            align-items: center; height: 100%; padding: 20px; box-sizing: border-box; text-align: center;
        }
        #dashboard h1 { color: var(--primary-color); margin-bottom: 10px; font-size: 32px; }
        #dashboard p { color: var(--sub-text-color); margin-top: 0; margin-bottom: 30px; }
        .stats-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; 
            width: 100%; max-width: 400px; margin: 20px 0; 
        }
        .stat-box { 
            background: var(--card-bg); padding: 15px; border-radius: 12px; 
            text-align: center; box-shadow: 0 4px 12px var(--shadow-color); 
        }
        .stat-box .label { font-size: 14px; color: var(--sub-text-color); margin-bottom: 5px; }
        .stat-box .value { font-size: 28px; font-weight: bold; }
        #review-value { color: var(--warning-color); }
        #mastered-value { color: var(--success-color); }
        .start-btn { 
            width: 100%; max-width: 400px; padding: 18px; font-size: 20px; 
            font-weight: bold; cursor: pointer; border: none; border-radius: 12px; 
            background-color: var(--primary-color); color: white; margin-top: 10px; 
            transition: all 0.2s;
        }
        .start-btn:hover { filter: brightness(1.1); }
        .start-btn:active { transform: scale(0.98); }
        
        /* Study Screen */
        #study-screen { display: none; flex-direction: column; height: 100%; }
        .study-header { 
            padding: 15px; text-align: center; background: var(--card-bg); 
            box-shadow: 0 2px 4px var(--shadow-color); z-index: 10; position: relative;
        }
        .progress-info { font-size: 18px; font-weight: 600; color: var(--primary-color); }
        
        /* Card Area */
        .card-area { 
            flex-grow: 1; display: flex; justify-content: center; 
            align-items: center; padding: 20px; overflow: hidden; position: relative;
        }
        .card { 
            width: 100%; max-width: 450px; background: var(--card-bg);
            border-radius: 16px; box-shadow: 0 8px 30px var(--shadow-color);
            padding: 30px; box-sizing: border-box;
            transition: all 0.3s ease;
        }
        .topic-tag { 
            background: var(--primary-color); color: white;
            font-size: 12px; padding: 6px 12px; border-radius: 20px; 
            font-weight: 600; display: inline-block; margin-bottom: 20px;
        }
        .question { font-size: 20px; font-weight: 600; line-height: 1.5; margin-bottom: 25px; }
        
        /* Active Recall Input */
        .recall-section { text-align: center; }
        #recall-input {
            width: 100%; padding: 12px 15px; font-size: 16px;
            border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box;
            margin-bottom: 15px;
        }
        #recall-input:focus { border-color: var(--primary-color); outline: none; }
        #submit-answer-btn {
            width: 100%; padding: 12px; font-size: 16px; font-weight: bold;
            cursor: pointer; border: none; border-radius: 8px;
            background-color: var(--primary-color); color: white;
        }

        /* Answer Section */
        #answer-section { display: none; margin-top: 25px; }
        .answer-header { font-size: 14px; color: var(--sub-text-color); font-weight: bold; margin-bottom: 5px; }
        .answer-box { 
            padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            border: 2px solid;
        }
        .answer-box[data-correct="true"] { border-color: var(--success-color); background-color: #f0fdf4;}
        .answer-box[data-correct="false"] { border-color: var(--danger-color); background-color: #fff1f2;}
        .answer-content { font-size: 18px; font-weight: bold; line-height: 1.4; margin-bottom: 10px;}
        .user-answer { font-size: 14px; color: var(--sub-text-color); word-break: break-all; }
        .user-answer strong { color: var(--text-color); }
        
        /* Elaboration Section */
        #elaboration-section { text-align: center; }
        #elaboration-section p { font-size: 16px; font-weight: 500; margin-bottom: 15px; }
        .elaboration-btns { display: flex; gap: 15px; }
        .elaboration-btn {
            flex: 1; padding: 15px; font-size: 16px; font-weight: bold;
            cursor: pointer; border-radius: 8px; border: 2px solid;
            background: transparent; transition: all 0.2s;
        }
        .btn-confident { border-color: var(--success-color); color: var(--success-color); }
        .btn-confident:hover { background: var(--success-color); color: white; }
        .btn-not-confident { border-color: var(--warning-color); color: var(--warning-color); }
        .btn-not-confident:hover { background: var(--warning-color); color: white; }
        
        #back-to-dash { 
            position: fixed; top: 15px; right: 15px; z-index: 200; 
            background: rgba(0,0,0,0.1); color: var(--text-color); border-radius: 50%; 
            width: 40px; height: 40px; display: flex; justify-content: center; 
            align-items: center; font-weight: bold; cursor: pointer; border: 1px solid #ddd;
        }
        strong { color: var(--primary-color); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Dashboard Screen -->
        <div id="dashboard">
            <h1>高密度エンコーディング</h1>
            <p>検索練習・精緻化・交錯学習で知識を脳に刻み込む</p>
            <div class="stats-grid">
                <div class="stat-box"><div class="label">全問題数</div><div class="value" id="total-value">0</div></div>
                <div class="stat-box"><div class="label">要復習</div><div class="value" id="review-value">0</div></div>
            </div>
            <button class="start-btn" id="start-btn">学習セッションを開始</button>
            <button class="start-btn" id="reset-progress" style="margin-top:20px; background-color: #9ca3af; font-size: 14px;">学習記録をリセット</button>
        </div>

        <!-- Study Screen -->
        <div id="study-screen">
            <div class="study-header">
                <div class="progress-info" id="progress-info"></div>
            </div>
            <div class="card-area" id="card-area">
                <div class="card">
                    <span class="topic-tag" id="topic-tag"></span>
                    <p class="question" id="question"></p>
                    
                    <div class="recall-section" id="recall-section">
                        <input type="text" id="recall-input" placeholder="答えを入力...">
                        <button id="submit-answer-btn">回答を確定</button>
                    </div>

                    <div id="answer-section">
                        <div class="answer-box" id="answer-box">
                           <div class="answer-header">正解</div>
                           <p class="answer-content" id="answer-content"></p>
                           <p class="user-answer">あなたの回答: <strong id="user-answer-text"></strong></p>
                        </div>
                        <div id="elaboration-section">
                            <p>この答えの理由や背景を説明できますか？</p>
                            <div class="elaboration-btns">
                                <button class="elaboration-btn btn-not-confident" id="eval-not-confident">自信なし</button>
                                <button class="elaboration-btn btn-confident" id="eval-confident">自信あり</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="back-to-dash" title="ダッシュボードに戻る">✕</div>
        </div>
    </div>

    <script>
    const initialCardData = [
        // (前回のコードと同じデータなので省略)
        // 答えのキーワードを抽出するため、a (answer) に加えて simple_a (simple answer) を追加
        // --- 地形 ---
        { topic: "地形/氷河地形", q: "氷河の侵食でできたU字谷に海水が侵入してできた海岸地形は？", a: "<strong>フィヨルド</strong>", simple_a: "フィヨルド", related: [1, 2] },
        { topic: "地形/氷河地形", q: "氷河が山頂付近を削ってできた、お椀型の谷を何というか？", a: "<strong>カール（圏谷）</strong>", simple_a: "カール,圏谷", related: [0, 2] },
        { topic: "地形/氷河地形", q: "氷河が運んだ土砂が堆積してできた丘を何と呼ぶか？", a: "<strong>モレーン</strong>", simple_a: "モレーン", related: [0, 1] },
        { topic: "地形/河川地形", q: "河川が山地から平野に出る所にできる、扇状の地形は？", a: "<strong>扇状地</strong>", simple_a: "扇状地", related: [4, 5, 6, 10] },
        { topic: "地形/河川地形", q: "扇状地の中央部（扇央）でよく見られる、普段は水が流れない川は？", a: "<strong>水無川</strong>", simple_a: "水無川", related: [3, 5, 13] },
        { topic: "地形/河川地形", q: "扇状地の末端（扇端）では、何が湧き出すため集落が発達しやすいか？", a: "<strong>湧水</strong>", simple_a: "湧水", related: [3, 4] },
        // ... 他のデータも同様に simple_a を追加してください
        { topic: "生活・植生・土壌/寒帯・高山", q: "アンデス山脈などの高山気候(H)で飼育される家畜2種は？", a: "<strong>リャマ</strong>、<strong>アルパカ</strong>", simple_a: "リャマ,アルパカ", related: [59, 77] }
    ];

    // 全データに `simple_a` がないとエラーになるので、暫定的に全データに `simple_a` を生成する
    initialCardData.forEach(card => {
        if (!card.simple_a) {
            // HTMLタグを除去し、主要な単語を抽出する簡易的な処理
            card.simple_a = card.a.replace(/<strong>/g, '').replace(/<\/strong>/g, '').split('（')[0].trim();
        }
    });


    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            // --- 状態管理 ---
            state: {
                cardData: [],
                cardScores: [], // { id, score } score: 0-100
                studyQueue: [],
                currentIndex: 0,
                currentCard: null,
            },

            // --- DOMキャッシュ ---
            dom: {},

            // --- 定数 ---
            STORAGE_KEY: 'geoEncodingSystem_v1',
            SCORE_INCREMENT: 10, // 自信あり
            SCORE_DECREMENT: 20, // 自信なし
            SCORE_THRESHOLD: 80, // 復習対象から外れるスコア

            // --- 初期化 ---
            init() {
                this.cacheDOM();
                this.state.cardData = initialCardData.map((card, index) => ({ ...card, id: index }));
                this.loadScores();
                this.updateDashboard();
                this.bindEvents();
                this.showDashboard();
            },

            cacheDOM() {
                this.dom = {
                    dashboard: document.getElementById('dashboard'),
                    studyScreen: document.getElementById('study-screen'),
                    progressInfo: document.getElementById('progress-info'),
                    topicTag: document.getElementById('topic-tag'),
                    question: document.getElementById('question'),
                    recallSection: document.getElementById('recall-section'),
                    recallInput: document.getElementById('recall-input'),
                    submitAnswerBtn: document.getElementById('submit-answer-btn'),
                    answerSection: document.getElementById('answer-section'),
                    answerBox: document.getElementById('answer-box'),
                    answerContent: document.getElementById('answer-content'),
                    userAnswerText: document.getElementById('user-answer-text'),
                    elaborationSection: document.getElementById('elaboration-section'),
                    evalConfidentBtn: document.getElementById('eval-confident'),
                    evalNotConfidentBtn: document.getElementById('eval-not-confident'),
                    startBtn: document.getElementById('start-btn'),
                    resetProgressBtn: document.getElementById('reset-progress'),
                    backToDashBtn: document.getElementById('back-to-dash'),
                };
            },

            bindEvents() {
                this.dom.startBtn.addEventListener('click', () => this.startStudy());
                this.dom.resetProgressBtn.addEventListener('click', () => this.resetProgress());
                this.dom.backToDashBtn.addEventListener('click', () => this.showDashboard());
                this.dom.submitAnswerBtn.addEventListener('click', () => this.checkAnswer());
                this.dom.recallInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.checkAnswer();
                });
                this.dom.evalConfidentBtn.addEventListener('click', () => this.evaluate(true));
                this.dom.evalNotConfidentBtn.addEventListener('click', () => this.evaluate(false));
            },

            // --- データ管理 ---
            loadScores() {
                let savedData;
                try {
                    savedData = JSON.parse(localStorage.getItem(this.STORAGE_KEY));
                    if (!Array.isArray(savedData) || savedData.length !== this.state.cardData.length) {
                        savedData = null;
                    }
                } catch (e) { savedData = null; }
                this.state.cardScores = savedData || this.state.cardData.map(c => ({ id: c.id, score: 0 }));
                this.saveScores();
            },

            saveScores() {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.state.cardScores));
                } catch (e) { console.error("Save failed:", e); }
            },

            resetProgress() {
                if (confirm('⚠️ すべての学習記録がリセットされます。よろしいですか？')) {
                    this.state.cardScores = this.state.cardData.map(c => ({ id: c.id, score: 0 }));
                    this.saveScores();
                    this.updateDashboard();
                    alert('学習記録をリセットしました。');
                }
            },

            // --- UI制御 ---
            updateDashboard() {
                document.getElementById('total-value').textContent = this.state.cardData.length;
                const reviewCount = this.state.cardScores.filter(s => s.score < this.SCORE_THRESHOLD).length;
                document.getElementById('review-value').textContent = reviewCount;
            },

            showDashboard() {
                this.dom.dashboard.style.display = 'flex';
                this.dom.studyScreen.style.display = 'none';
                this.updateDashboard();
            },
            
            // --- 学習フロー ---
            startStudy() {
                // インターリービング・キューを生成
                const reviewCards = this.state.cardScores.filter(s => s.score < this.SCORE_THRESHOLD);
                if (reviewCards.length === 0) {
                    alert("🎉 全問マスター済みです！おめでとうございます！");
                    return;
                }
                
                this.state.studyQueue = this.createInterleavedQueue(reviewCards.map(c => c.id));
                this.state.currentIndex = 0;

                this.dom.dashboard.style.display = 'none';
                this.dom.studyScreen.style.display = 'flex';
                this.renderCard(this.state.studyQueue[0]);
            },
            
            createInterleavedQueue(cardIds) {
                // トピックごとにカードをグループ化
                const groupedByTopic = {};
                cardIds.forEach(id => {
                    const topic = this.state.cardData[id].topic.split('/')[0]; // 大分類でグループ化
                    if (!groupedByTopic[topic]) {
                        groupedByTopic[topic] = [];
                    }
                    groupedByTopic[topic].push(id);
                });

                // 各グループをシャッフル
                for (const topic in groupedByTopic) {
                    this.shuffleArray(groupedByTopic[topic]);
                }

                const interleavedQueue = [];
                const topics = Object.keys(groupedByTopic);
                let lastTopic = null;

                while(interleavedQueue.length < cardIds.length) {
                    // 前回と違うトピックを優先的に選択
                    let availableTopics = topics.filter(t => groupedByTopic[t].length > 0 && t !== lastTopic);
                    if (availableTopics.length === 0) {
                        availableTopics = topics.filter(t => groupedByTopic[t].length > 0);
                    }
                    
                    const nextTopic = availableTopics[Math.floor(Math.random() * availableTopics.length)];
                    const nextCardId = groupedByTopic[nextTopic].shift();
                    interleavedQueue.push(nextCardId);
                    lastTopic = nextTopic;
                }
                
                return interleavedQueue;
            },

            renderCard(cardId) {
                this.state.currentCard = this.state.cardData.find(c => c.id === cardId);
                const { topic, q } = this.state.currentCard;

                this.dom.topicTag.textContent = topic;
                this.dom.question.textContent = q;
                
                this.dom.progressInfo.textContent = `残り ${this.state.studyQueue.length - this.state.currentIndex} 問`;

                // UIを初期状態に戻す
                this.dom.recallSection.style.display = 'block';
                this.dom.answerSection.style.display = 'none';
                this.dom.recallInput.value = '';
                this.dom.recallInput.focus();
            },

            checkAnswer() {
                const userAnswer = this.dom.recallInput.value.trim();
                if (!userAnswer) return;

                const { a, simple_a } = this.state.currentCard;
                
                // 複数の正解キーワードに対応
                const correctKeywords = simple_a.split(',').map(k => k.trim());
                const isCorrect = correctKeywords.some(keyword => userAnswer.includes(keyword));
                
                // 回答表示エリアの準備
                this.dom.answerContent.innerHTML = a;
                this.dom.userAnswerText.textContent = userAnswer;
                this.dom.answerBox.dataset.correct = isCorrect;
                
                // UI切り替え
                this.dom.recallSection.style.display = 'none';
                this.dom.answerSection.style.display = 'block';
            },

            evaluate(isConfident) {
                const cardScore = this.state.cardScores.find(s => s.id === this.state.currentCard.id);
                
                if (isConfident) {
                    cardScore.score = Math.min(100, cardScore.score + this.SCORE_INCREMENT);
                } else {
                    cardScore.score = Math.max(0, cardScore.score - this.SCORE_DECREMENT);
                }
                
                this.saveScores();
                this.proceedToNextCard();
            },

            proceedToNextCard() {
                this.state.currentIndex++;
                if (this.state.currentIndex < this.state.studyQueue.length) {
                    const nextCardId = this.state.studyQueue[this.state.currentIndex];
                    // フェードアウト・インのような演出（簡易版）
                    this.dom.studyScreen.querySelector('.card').style.opacity = 0;
                    setTimeout(() => {
                        this.renderCard(nextCardId);
                        this.dom.studyScreen.querySelector('.card').style.opacity = 1;
                    }, 300);
                } else {
                    alert("🎉 学習セッション完了！");
                    this.showDashboard();
                }
            },

            // --- ユーティリティ ---
            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
        };

        App.init();
    });
    </script>
</body>
</html>